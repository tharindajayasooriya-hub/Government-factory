<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .workshop-card {
            transition: all 0.3s ease;
        }
        .workshop-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 via-blue-50 to-slate-100 min-h-screen">
    
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl shadow-2xl p-10 max-w-md w-full fade-in">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üîß</div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Admin Login</h1>
                <p class="text-gray-600 text-lg">Maintenance Management System</p>
                <p class="text-gray-500 text-sm mt-2">Department of Government Factory</p>
            </div>
            
            <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
                Invalid username or password!
            </div>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onkeypress="if(event.key==='Enter') attemptLogin()">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onkeypress="if(event.key==='Enter') attemptLogin()">
                </div>
            </div>
            
            <button onclick="attemptLogin()" 
                    class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 transition shadow-lg">
                Login
            </button>
            
            <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-sm text-gray-600 font-medium mb-2">Default Admin Credentials:</p>
                <p class="text-sm text-gray-700">Username: <span class="font-mono font-bold">admin</span></p>
                <p class="text-sm text-gray-700">Password: <span class="font-mono font-bold">admin123</span></p>
                <p class="text-xs text-orange-600 mt-2">‚ö†Ô∏è Change these credentials in production!</p>
            </div>
        </div>
    </div>

    <!-- Workshop Selection Page -->
    <div id="landingPage" class="hidden min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-start mb-8">
                <div class="text-center flex-1">
                    <h1 class="text-6xl font-bold text-gray-800 mb-4">Maintenance Management System</h1>
                    <p class="text-3xl text-gray-600 mb-2">Department of Government Factory</p>
                    <button onclick="logout()" class="mt-4 bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition">
                        üö™ Logout
                    </button>
                </div>
                
                <div class="flex flex-col gap-3">
                    <button onclick="showMachineManagement()" class="bg-amber-600 text-white px-5 py-3 rounded-xl hover:bg-amber-700 transition shadow-lg font-medium whitespace-nowrap">
                        ‚ûï Add Machine
                    </button>
                    <button onclick="showEngineerManagement()" class="bg-green-600 text-white px-5 py-3 rounded-xl hover:bg-green-700 transition shadow-lg font-medium whitespace-nowrap">
                        üë∑ Add Engineer
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-2xl p-12 fade-in">
                <h2 class="text-3xl font-bold text-gray-700 text-center mb-10">Select Workshop</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <button onclick="openWorkshop('Workshop 01', 'Electro Mechanical')" 
                            class="workshop-card bg-gradient-to-br from-blue-500 to-blue-600 text-white font-bold py-12 px-8 rounded-2xl text-2xl shadow-xl">
                        <div class="text-5xl mb-3">üîß</div>
                        Workshop 01
                        <div class="text-sm mt-2 font-normal">Electro Mechanical</div>
                    </button>
                    <button onclick="openWorkshop('Workshop 02', 'Heavy Fabrication')" 
                            class="workshop-card bg-gradient-to-br from-green-500 to-green-600 text-white font-bold py-12 px-8 rounded-2xl text-2xl shadow-xl">
                        <div class="text-5xl mb-3">‚öôÔ∏è</div>
                        Workshop 02
                        <div class="text-sm mt-2 font-normal">Heavy Fabrication</div>
                    </button>
                    <button onclick="openWorkshop('Workshop 03', 'Carpentry')" 
                            class="workshop-card bg-gradient-to-br from-purple-500 to-purple-600 text-white font-bold py-12 px-8 rounded-2xl text-2xl shadow-xl">
                        <div class="text-5xl mb-3">üõ†Ô∏è</div>
                        Workshop 03
                        <div class="text-sm mt-2 font-normal">Carpentry</div>
                    </button>
                    <button onclick="openWorkshop('Workshop 04', 'Light Fabrication')" 
                            class="workshop-card bg-gradient-to-br from-orange-500 to-orange-600 text-white font-bold py-12 px-8 rounded-2xl text-2xl shadow-xl">
                        <div class="text-5xl mb-3">üî©</div>
                        Workshop 04
                        <div class="text-sm mt-2 font-normal">Light Fabrication</div>
                    </button>
                    <button onclick="openWorkshop('Workshop 05', 'Workshop 05')" 
                            class="workshop-card bg-gradient-to-br from-red-500 to-red-600 text-white font-bold py-12 px-8 rounded-2xl text-2xl shadow-xl">
                        <div class="text-5xl mb-3">üè≠</div>
                        Workshop 05
                    </button>
                    <button onclick="openWorkshop('Workshop 06', 'Foundry')" 
                            class="workshop-card bg-gradient-to-br from-indigo-500 to-indigo-600 text-white font-bold py-12 px-8 rounded-2xl text-2xl shadow-xl">
                        <div class="text-5xl mb-3">‚ö°</div>
                        Workshop 06
                        <div class="text-sm mt-2 font-normal">Foundry</div>
                    </button>
                    <button onclick="openWorkshop('Workshop 07', 'Multi Crafting')" 
                            class="workshop-card bg-gradient-to-br from-teal-500 to-teal-600 text-white font-bold py-12 px-8 rounded-2xl text-2xl shadow-xl">
                        <div class="text-5xl mb-3">üî®</div>
                        Workshop 07
                        <div class="text-sm mt-2 font-normal">Multi Crafting</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Machine Management Page -->
    <div id="machineManagementPage" class="hidden min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div class="flex justify-between items-center mb-6 pb-4 border-b-2">
                    <h1 class="text-4xl font-bold text-gray-800">Machine Management</h1>
                    <button onclick="backToHome()" class="bg-gray-600 text-white px-6 py-3 rounded-xl hover:bg-gray-700 transition shadow-lg font-medium">
                        ‚Üê Back to Home
                    </button>
                </div>

                <div class="bg-gradient-to-r from-amber-50 to-amber-100 p-6 rounded-2xl mb-6 border-2 border-amber-300 shadow-lg">
                    <h3 class="font-bold text-2xl mb-4 text-amber-800">‚ûï Add New Machine</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-bold mb-2">Workshop:</label>
                            <select id="machineWorkshop" class="w-full p-3 border-2 rounded-xl" onchange="updateCategoriesByWorkshop()">
                                <option value="">Select Workshop</option>
                                <option value="Workshop 01">Workshop 01 - Electro Mechanical</option>
                                <option value="Workshop 02">Workshop 02 - Heavy Fabrication</option>
                                <option value="Workshop 03">Workshop 03 - Carpentry</option>
                                <option value="Workshop 04">Workshop 04 - Light Fabrication</option>
                                <option value="Workshop 05">Workshop 05</option>
                                <option value="Workshop 06">Workshop 06 - Foundry</option>
                                <option value="Workshop 07">Workshop 07 - Multi Crafting</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Main Category:</label>
                            <select id="machineCategory" class="w-full p-3 border-2 rounded-xl" onchange="updateMachineNames()">
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Machine Name:</label>
                            <select id="machineName" class="w-full p-3 border-2 rounded-xl">
                                <option value="">Select category first</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Identification Number:</label>
                            <input type="text" id="machineIdentification" placeholder="e.g., M-2024-001" class="w-full p-3 border-2 rounded-xl">
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Manufactured Year:</label>
                            <input type="number" id="machineYear" placeholder="e.g., 2020" min="1900" max="2100" class="w-full p-3 border-2 rounded-xl">
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Manufactured Country:</label>
                            <input type="text" id="machineCountry" placeholder="e.g., Germany, Japan, USA" class="w-full p-3 border-2 rounded-xl">
                        </div>
                        <div class="col-span-2">
                            <label class="block font-bold mb-2">Description:</label>
                            <textarea id="machineDescription" placeholder="Enter machine description, specifications, or notes..." class="w-full p-3 border-2 rounded-xl" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="saveMachine()" class="bg-amber-600 text-white px-6 py-3 rounded-xl hover:bg-amber-700 font-bold shadow-lg">Save Machine</button>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-2xl mb-4">All Machines by Workshop:</h4>
                    <div id="machinesList" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Engineer Management Page -->
    <div id="engineerManagementPage" class="hidden min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div class="flex justify-between items-center mb-6 pb-4 border-b-2">
                    <h1 class="text-4xl font-bold text-gray-800">Engineer Management</h1>
                    <button onclick="backToHome()" class="bg-gray-600 text-white px-6 py-3 rounded-xl hover:bg-gray-700 transition shadow-lg font-medium">
                        ‚Üê Back to Home
                    </button>
                </div>

                <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-2xl mb-6 border-2 border-green-300 shadow-lg">
                    <h3 class="font-bold text-2xl mb-4 text-green-800">üë∑ Add New Engineer</h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <input type="text" id="engineerName" placeholder="Engineer name" class="p-3 border-2 rounded-xl">
                        <input type="email" id="engineerEmail" placeholder="Email address" class="p-3 border-2 rounded-xl">
                        <input type="text" id="engineerDept" placeholder="Department" class="p-3 border-2 rounded-xl">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="saveEngineer()" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 font-bold shadow-lg">Save Engineer</button>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-2xl mb-4">Current Engineers:</h4>
                    <div id="engineersList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workshop Tracker Interface -->
    <div id="workshopTracker" class="hidden p-6">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex flex-col gap-3">
                        <div class="flex gap-3">
                            <button onclick="goHome()" class="bg-gray-600 text-white px-5 py-3 rounded-xl hover:bg-gray-700 transition shadow-lg font-medium">üè† Home</button>
                            <button onclick="logout()" class="bg-red-600 text-white px-5 py-3 rounded-xl hover:bg-red-700 transition shadow-lg font-medium">üö™ Logout</button>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportData()" class="bg-teal-600 text-white px-5 py-3 rounded-xl hover:bg-teal-700 transition shadow-lg font-medium">üíæ Export</button>
                            <button onclick="document.getElementById('fileInput').click()" class="bg-indigo-600 text-white px-5 py-3 rounded-xl hover:bg-indigo-700 transition shadow-lg font-medium">üìÇ Load</button>
                            <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadData(event)">
                        </div>
                    </div>

                    <div class="text-center">
                        <h2 id="workshopTitle" class="text-3xl font-bold text-gray-800">Workshop 01</h2>
                        <p id="workshopDescription" class="text-lg text-gray-600 mt-1">Electro Mechanical</p>
                    </div>

                    <div class="flex flex-col gap-3 items-end">
                        <div class="flex gap-3">
                            <button onclick="showMachineList()" class="bg-cyan-600 text-white px-5 py-3 rounded-xl hover:bg-cyan-700 transition shadow-lg font-medium">
                                üîß Machine List
                            </button>
                            <button onclick="toggleNotifications()" class="bg-orange-600 text-white px-5 py-3 rounded-xl hover:bg-orange-700 transition shadow-lg font-medium relative">
                                üîî Notifications <span id="notifBadge"></span>
                            </button>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="toggleImport()" class="bg-purple-600 text-white px-5 py-3 rounded-xl hover:bg-purple-700 transition shadow-lg font-medium">üìä Import Excel</button>
                            <button onclick="toggleAddTask()" class="bg-blue-600 text-white px-5 py-3 rounded-xl hover:bg-blue-700 transition shadow-lg font-medium">‚ú® Add Task</button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 mb-6 border-b-2 border-gray-200">
                    <button onclick="switchTab('preventive')" id="tabPreventive" class="px-6 py-3 font-bold text-lg border-b-4 border-blue-600 text-blue-600">Preventive Maintenance</button>
                    <button onclick="switchTab('breakdown')" id="tabBreakdown" class="px-6 py-3 font-bold text-lg border-b-4 border-transparent text-gray-500 hover:text-gray-700">Breakdown Maintenance</button>
                </div>

                <div id="preventiveContent">
                    <div id="importPanel" class="hidden bg-gradient-to-r from-purple-50 to-purple-100 p-6 rounded-2xl mb-6 border-2 border-purple-300 shadow-lg">
                        <h3 class="font-bold text-2xl mb-4 text-purple-800">üìä Import Maintenance Calendar from Excel</h3>
                        <div class="bg-blue-50 p-5 rounded-xl mb-5 border border-blue-300">
                            <h4 class="font-bold mb-3 text-blue-800">üìã How to Import:</h4>
                            <ol class="list-decimal ml-5 space-y-2">
                                <li>Select machine and engineer, choose start date</li>
                                <li>Copy rows from Excel (Task, Frequency columns)</li>
                                <li>Paste below and click Import</li>
                            </ol>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block font-bold mb-2">Select Machine:</label>
                                <select id="importMachine" class="w-full p-3 border-2 rounded-xl"></select>
                            </div>
                            <div>
                                <label class="block font-bold mb-2">Select Engineer:</label>
                                <select id="importEngineer" class="w-full p-3 border-2 rounded-xl"></select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block font-bold mb-2">Start Date:</label>
                            <input type="date" id="importDate" class="w-full p-3 border-2 rounded-xl">
                        </div>
                        <textarea id="importData" placeholder="Paste Excel data here..." class="w-full p-4 border-2 rounded-xl font-mono text-sm mb-4" rows="8"></textarea>
                        <div class="flex gap-3">
                            <button onclick="importExcelData()" class="bg-purple-600 text-white px-8 py-3 rounded-xl hover:bg-purple-700 font-bold shadow-lg">Import Tasks</button>
                            <button onclick="toggleImport()" class="bg-gray-300 text-gray-700 px-8 py-3 rounded-xl hover:bg-gray-400 font-bold">Cancel</button>
                        </div>
                    </div>

                    <div id="notifPanel" class="hidden bg-gradient-to-r from-orange-50 to-orange-100 p-6 rounded-2xl mb-6 border-2 border-orange-300 shadow-lg">
                        <h3 class="font-bold text-2xl mb-4 text-orange-800">üîî Email Notifications (1 Day Before)</h3>
                        <div id="notifContent"></div>
                    </div>

                    <div id="addTaskPanel" class="hidden bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-2xl mb-6 border-2 border-blue-300 shadow-lg">
                        <h3 class="font-bold text-2xl mb-4 text-blue-800">‚ú® Add New Maintenance Task</h3>
                        <div class="grid grid-cols-4 gap-4 mb-4">
                            <select id="taskMachine" class="p-3 border-2 rounded-xl" style="color: #9CA3AF;" onchange="this.style.color='black';"></select>
                            <select id="taskPriority" class="p-3 border-2 rounded-xl" style="color: #9CA3AF;" onchange="this.style.color='black';">
                                <option value="" disabled selected>Priority</option>
                                <option value="Low" style="color: black;">Low</option>
                                <option value="Medium" style="color: black;">Medium</option>
                                <option value="High" style="color: black;">High</option>
                            </select>
                            <input type="text" id="taskName" placeholder="Task name" class="p-3 border-2 rounded-xl">
                            <select id="taskFreq" class="p-3 border-2 rounded-xl" style="color: #9CA3AF;" onchange="this.style.color='black';">
                                <option value="" disabled selected>Frequency</option>
                                <option value="Daily" style="color: black;">Daily</option>
                                <option value="Weekly" style="color: black;">Weekly</option>
                                <option value="Monthly" style="color: black;">Monthly</option>
                                <option value="Quarterly" style="color: black;">Quarterly</option>
                                <option value="Semi Annually" style="color: black;">Semi Annually</option>
                                <option value="Annually" style="color: black;">Annually</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <select id="taskEngineer" class="p-3 border-2 rounded-xl"></select>
                            <input type="date" id="taskLastDone" placeholder="Last Done Date" class="p-3 border-2 rounded-xl" onchange="calculateNextDueDate()">
                            <input type="date" id="taskNextDue" placeholder="Next Due Date" class="p-3 border-2 rounded-xl">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveTask()" class="bg-blue-600 text-white px-8 py-3 rounded-xl hover:bg-blue-700 font-bold shadow-lg">Save Task</button>
                            <button onclick="toggleAddTask()" class="bg-gray-300 text-gray-700 px-8 py-3 rounded-xl hover:bg-gray-400 font-bold">Cancel</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-5 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-2xl border-2 border-gray-300 shadow-lg">
                            <div id="statTotal" class="text-4xl font-bold text-gray-800">0</div>
                            <div class="text-sm text-gray-600 font-medium mt-1">Total Tasks</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-2xl border-2 border-green-300 shadow-lg">
                            <div id="statCompleted" class="text-4xl font-bold text-green-800">0</div>
                            <div class="text-sm text-green-600 font-medium mt-1">Completed</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl border-2 border-blue-300 shadow-lg">
                            <div id="statInProgress" class="text-4xl font-bold text-blue-800">0</div>
                            <div class="text-sm text-blue-600 font-medium mt-1">In Progress</div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-2xl border-2 border-yellow-300 shadow-lg">
                            <div id="statPending" class="text-4xl font-bold text-yellow-800">0</div>
                            <div class="text-sm text-yellow-600 font-medium mt-1">Pending</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-2xl border-2 border-red-300 shadow-lg">
                            <div id="statOverdue" class="text-4xl font-bold text-red-800">0</div>
                            <div class="text-sm text-red-600 font-medium mt-1">Overdue</div>
                        </div>
                    </div>

                    <div class="flex gap-3 mb-6 items-center bg-gray-50 p-4 rounded-xl">
                        <div class="flex gap-2">
                            <button onclick="filterTasks('all')" id="filterAll" class="px-5 py-2 rounded-xl bg-blue-600 text-white font-medium shadow-md">All</button>
                            <button onclick="filterTasks('pending')" id="filterPending" class="px-5 py-2 rounded-xl bg-gray-200 font-medium">Pending</button>
                            <button onclick="filterTasks('in-progress')" id="filterInProgress" class="px-5 py-2 rounded-xl bg-gray-200 font-medium">In Progress</button>
                            <button onclick="filterTasks('overdue')" id="filterOverdue" class="px-5 py-2 rounded-xl bg-gray-200 font-medium">Overdue</button>
                            <button onclick="filterTasks('completed')" id="filterCompleted" class="px-5 py-2 rounded-xl bg-gray-200 font-medium">Completed</button>
                        </div>
                        <div class="flex-1"></div>
                        <div class="flex items-center gap-3">
                            <label class="text-gray-700 font-bold">üîç Search:</label>
                            <input type="text" id="machineSearch" placeholder="Type machine name..." oninput="searchMachines()" class="px-4 py-2 border-2 rounded-xl w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="clearSearch()" class="px-4 py-2 bg-gray-400 text-white rounded-xl hover:bg-gray-500 font-medium">Clear</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
                        <table class="w-full">
                            <thead class="bg-gradient-to-r from-gray-700 to-gray-800 text-white">
                                <tr>
                                    <th class="text-left p-4 font-bold">Machine</th>
                                    <th class="text-left p-4 font-bold">Priority</th>
                                    <th class="text-left p-4 font-bold">Task</th>
                                    <th class="text-left p-4 font-bold">Last Done</th>
                                    <th class="text-left p-4 font-bold">Next Due</th>
                                    <th class="text-left p-4 font-bold">Frequency</th>
                                    <th class="text-left p-4 font-bold">Status</th>
                                    <th class="text-left p-4 font-bold">Engineer</th>
                                    <th class="text-left p-4 font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTable"></tbody>
                        </table>
                    </div>
                </div>

                <div id="breakdownContent" class="hidden">
                    <div class="mb-6 flex justify-end">
                        <button onclick="toggleAddBreakdown()" class="bg-red-600 text-white px-6 py-3 rounded-xl hover:bg-red-700 transition shadow-lg font-medium">
                            ‚ö†Ô∏è Add Breakdown
                        </button>
                    </div>

                    <div id="addBreakdownPanel" class="bg-gradient-to-r from-red-50 to-red-100 p-6 rounded-2xl mb-6 border-2 border-red-300 shadow-lg hidden">
                        <h3 class="font-bold text-2xl mb-4 text-red-800">‚ö†Ô∏è Record Machine Breakdown</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block font-bold mb-2">Machine Name:</label>
                                <select id="breakdownMachine" class="w-full p-3 border-2 rounded-xl"></select>
                            </div>
                            <div>
                                <label class="block font-bold mb-2">Responsible Engineer:</label>
                                <select id="breakdownEngineer" class="w-full p-3 border-2 rounded-xl"></select>
                            </div>
                            <div>
                                <label class="block font-bold mb-2">Model:</label>
                                <input type="text" id="breakdownModel" placeholder="Enter model" class="w-full p-3 border-2 rounded-xl">
                            </div>
                            <div>
                                <label class="block font-bold mb-2">Date of Breakdown:</label>
                                <input type="date" id="breakdownDate" class="w-full p-3 border-2 rounded-xl">
                            </div>
                            <div class="col-span-2">
                                <label class="block font-bold mb-2">Problem Description:</label>
                                <textarea id="breakdownProblem" placeholder="Describe the breakdown problem..." class="w-full p-3 border-2 rounded-xl" rows="4"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveBreakdown()" class="bg-red-600 text-white px-8 py-3 rounded-xl hover:bg-red-700 font-bold shadow-lg">Save Breakdown</button>
                            <button onclick="toggleAddBreakdown()" class="bg-gray-300 text-gray-700 px-8 py-3 rounded-xl hover:bg-gray-400 font-bold">Cancel</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
                        <table class="w-full">
                            <thead class="bg-gradient-to-r from-red-700 to-red-800 text-white">
                                <tr>
                                    <th class="text-left p-4 font-bold">Machine Name</th>
                                    <th class="text-left p-4 font-bold">Responsible Engineer</th>
                                    <th class="text-left p-4 font-bold">Model</th>
                                    <th class="text-left p-4 font-bold">Problem</th>
                                    <th class="text-left p-4 font-bold">Date of Breakdown</th>
                                    <th class="text-left p-4 font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="breakdownTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Machine List Page -->
    <div id="machineListPage" class="hidden p-6">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div class="flex justify-between items-center mb-6 pb-4 border-b-2">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-800">Machine List & Status</h1>
                        <p class="text-lg text-gray-600 mt-2">
                            <span id="machineListWorkshopTitle" class="font-bold"></span> - 
                            <span id="machineListWorkshopDesc"></span>
                        </p>
                    </div>
                    <button onclick="backToWorkshop()" class="bg-gray-600 text-white px-6 py-3 rounded-xl hover:bg-gray-700 transition shadow-lg font-medium">
                        ‚Üê Back to Workshop
                    </button>
                </div>

                <div id="machineListContent"></div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin123';
        let isAuthenticated = false;
        let currentWorkshop = '';
        let currentWorkshopDescription = '';
        let machinesByWorkshop = {
            'Workshop 01': [],
            'Workshop 02': [],
            'Workshop 03': [],
            'Workshop 04': [],
            'Workshop 05': [],
            'Workshop 06': [],
            'Workshop 07': []
        };

        // Machine status tracking
        let machineStatuses = {}; // Format: { machineId: 'Working' | 'Under Maintenance' | 'Broken Down' }

        let engineers = [
            { id: 1, name: 'John Silva', email: 'john.silva@factory.gov.lk', department: 'Mechanical' },
            { id: 2, name: 'Sarah Fernando', email: 'sarah.fernando@factory.gov.lk', department: 'Mechanical' },
            { id: 3, name: 'Raj Kumar', email: 'raj.kumar@factory.gov.lk', department: 'CNC Operations' }
        ];

        const machineNamesByCategory = {
            'Lathe': ['CNC Lathe', 'Engine Lathe', 'Turret Lathe', 'Capstan Lathe'],
            'Milling': ['CNC Milling Machine', 'Vertical Milling Machine', 'Horizontal Milling Machine', 'Universal Mill'],
            'Drilling': ['Radial Drilling Machine', 'Bench Drilling Machine'],
            'Compressor': ['Reciprocating Compressor', 'Rotary Screw Compressor', 'Rotary Vane Compressor'],
            'Hoist': ['Manual Hoist', 'Electric Hoist'],
            'Slotting': ['Slotting Machine'],
            'Planning': ['Conventional Planing Machine', 'Plano-Milling Machine'],
            'Grinding': ['Bench Grinder', 'Surface Grinder', 'Tool Grinder'],
            'Shaping': ['Shaping Machine'],
            'Boring': ['Horizontal Boring Machine', 'Vertical Boring Machine'],
            'Press': ['Manual Press', 'Hydraulic Press'],
            'Threading': ['Threading Machine'],
            'Power Hack Saw': ['Power Hack Saw'],
            'Bolt Forging': ['Bolt Forging Machine'],
            'Hydraulic Shearing': ['Hydraulic Shearing Machine'],
            'Rolling': ['Rolling Machine'],
            'Power Press Cutting': ['Power Press Cutting Machine'],
            'Bar Straightening': ['Bar Straightening Machine'],
            'Drill': ['Drill Machine'],
            'CNC Plasma Cutter': ['CNC Plasma Cutter'],
            'Welding Plants': ['Welding Plant'],
            'Hollow Chisel Mortiser & Bore': ['Hollow Chisel Mortiser & Bore'],
            'Automatic Band Saw Sharpner & Setter': ['Automatic Band Saw Sharpner & Setter'],
            'Automatic Straight Cutter Grinder': ['Automatic Straight Cutter Grinder'],
            'Circular Saw Sharpner & Gulleter': ['Circular Saw Sharpner & Gulleter'],
            'Grinder': ['Grinder'],
            'Vertical Spindle Moulder': ['Vertical Spindle Moulder'],
            'Surface Planner & Thicknessor': ['Surface Planner & Thicknessor'],
            'Narrow Band Saw Vertical': ['Narrow Band Saw Vertical'],
            'Universal Tool Sharpner': ['Universal Tool Sharpner'],
            'Chain Chisel Mortiser': ['Chain Chisel Mortiser'],
            'Wood Mizer': ['Wood Mizer']
        };

        const categoriesByWorkshop = {
            'Workshop 01': ['Lathe', 'Milling', 'Drilling', 'Compressor', 'Hoist', 'Slotting', 'Planning', 'Grinding', 'Shaping', 'Boring', 'Press', 'Threading', 'Power Hack Saw', 'Bolt Forging'],
            'Workshop 02': ['Hydraulic Shearing', 'Rolling', 'Power Press Cutting', 'Bar Straightening', 'Power Hack Saw', 'Drill', 'CNC Plasma Cutter', 'Welding Plants', 'Grinding'],
            'Workshop 03': ['Hollow Chisel Mortiser & Bore', 'Automatic Band Saw Sharpner & Setter', 'Automatic Straight Cutter Grinder', 'Circular Saw Sharpner & Gulleter', 'Grinder', 'Vertical Spindle Moulder', 'Surface Planner & Thicknessor', 'Narrow Band Saw Vertical', 'Universal Tool Sharpner', 'Chain Chisel Mortiser', 'Wood Mizer'],
            'Workshop 04': [],
            'Workshop 05': [],
            'Workshop 06': [],
            'Workshop 07': []
        };

        let allTasks = [];
        let allBreakdowns = [];
        let currentFilter = 'all';
        let machineIdCounter = 1;
        let breakdownIdCounter = 1;
        let machineSearchQuery = '';
        let currentTab = 'preventive';

        function switchTab(tab) {
            currentTab = tab;
            
            if (tab === 'preventive') {
                document.getElementById('preventiveContent').classList.remove('hidden');
                document.getElementById('breakdownContent').classList.add('hidden');
                document.getElementById('tabPreventive').className = 'px-6 py-3 font-bold text-lg border-b-4 border-blue-600 text-blue-600';
                document.getElementById('tabBreakdown').className = 'px-6 py-3 font-bold text-lg border-b-4 border-transparent text-gray-500 hover:text-gray-700';
            } else {
                document.getElementById('preventiveContent').classList.add('hidden');
                document.getElementById('breakdownContent').classList.remove('hidden');
                document.getElementById('tabPreventive').className = 'px-6 py-3 font-bold text-lg border-b-4 border-transparent text-gray-500 hover:text-gray-700';
                document.getElementById('tabBreakdown').className = 'px-6 py-3 font-bold text-lg border-b-4 border-red-600 text-red-600';
                renderBreakdowns();
                updateBreakdownDropdowns();
            }
        }

        function toggleAddBreakdown() {
            const panel = document.getElementById('addBreakdownPanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                document.getElementById('breakdownMachine').value = '';
                document.getElementById('breakdownEngineer').value = '';
                document.getElementById('breakdownModel').value = '';
                document.getElementById('breakdownProblem').value = '';
                document.getElementById('breakdownDate').value = new Date().toISOString().split('T')[0];
                updateBreakdownDropdowns();
            }
        }

        function updateBreakdownDropdowns() {
            const machines = getWorkshopMachines();
            const machineSelect = document.getElementById('breakdownMachine');
            const engineerSelect = document.getElementById('breakdownEngineer');
            
            if (machineSelect) {
                if (machines.length === 0) {
                    machineSelect.innerHTML = '<option value="">No machines available</option>';
                } else {
                    machineSelect.innerHTML = '<option value="">Select Machine</option>' + 
                        machines.map(m => `<option value="${m.id}">${m.category ? m.category + ' - ' : ''}${m.name}</option>`).join('');
                }
            }

            if (engineerSelect) {
                engineerSelect.innerHTML = '<option value="">Select Engineer</option>' + 
                    engineers.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            }
        }

        function saveBreakdown() {
            const machineId = document.getElementById('breakdownMachine').value;
            const engineerId = document.getElementById('breakdownEngineer').value;
            const model = document.getElementById('breakdownModel').value.trim();
            const problem = document.getElementById('breakdownProblem').value.trim();
            const date = document.getElementById('breakdownDate').value;

            if (!machineId) {
                alert('Please select a machine');
                return;
            }

            if (!engineerId) {
                alert('Please select a responsible engineer');
                return;
            }

            if (!problem) {
                alert('Please describe the problem');
                return;
            }

            if (!date) {
                alert('Please select breakdown date');
                return;
            }

            const maxId = allBreakdowns.length > 0 ? Math.max(...allBreakdowns.map(b => b.id)) : 0;
            allBreakdowns.push({
                id: maxId + 1,
                machineId: parseInt(machineId),
                engineerId: parseInt(engineerId),
                model: model,
                problem: problem,
                date: date,
                workshop: currentWorkshop
            });

            // Update machine status to "Broken Down"
            machineStatuses[parseInt(machineId)] = 'Broken Down';

            alert('Breakdown recorded successfully!');
            renderBreakdowns();
            toggleAddBreakdown();
        }

        function getWorkshopBreakdowns() {
            return allBreakdowns.filter(b => b.workshop === currentWorkshop);
        }

        function renderBreakdowns() {
            const tbody = document.getElementById('breakdownTable');
            const breakdowns = getWorkshopBreakdowns();
            const machines = getWorkshopMachines();
            
            if (breakdowns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-500 text-lg">No breakdowns recorded yet.</td></tr>';
                return;
            }
            
            tbody.innerHTML = breakdowns.map(breakdown => {
                const machine = machines.find(m => m.id === breakdown.machineId);
                const engineer = engineers.find(e => e.id === breakdown.engineerId);
                
                return `
                    <tr class="border-b-2 hover:bg-red-50 transition">
                        <td class="p-4">
                            <div class="font-bold text-gray-800">${machine ? (machine.category ? machine.category + ' - ' : '') + machine.name : 'Unknown'}</div>
                        </td>
                        <td class="p-4">
                            <div class="font-bold text-blue-800">${engineer ? engineer.name : 'Unassigned'}</div>
                            <div class="text-xs text-gray-500">${engineer ? engineer.email : ''}</div>
                        </td>
                        <td class="p-4">${breakdown.model || '-'}</td>
                        <td class="p-4">${breakdown.problem}</td>
                        <td class="p-4 font-medium">${breakdown.date}</td>
                        <td class="p-4">
                            <button onclick="deleteBreakdown(${breakdown.id})" class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-red-600 font-medium">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deleteBreakdown(breakdownId) {
            if (confirm('Are you sure you want to delete this breakdown record?')) {
                const breakdown = allBreakdowns.find(b => b.id === breakdownId);
                if (breakdown) {
                    // Reset machine status to "Working" when breakdown is deleted
                    machineStatuses[breakdown.machineId] = 'Working';
                }
                allBreakdowns = allBreakdowns.filter(b => b.id !== breakdownId);
                renderBreakdowns();
                alert('Breakdown record deleted successfully!');
            }
        }

        function showMachineList() {
            document.getElementById('workshopTracker').classList.add('hidden');
            document.getElementById('machineListPage').classList.remove('hidden');
            document.getElementById('machineListWorkshopTitle').textContent = currentWorkshop;
            document.getElementById('machineListWorkshopDesc').textContent = currentWorkshopDescription;
            renderMachineList();
        }

        function backToWorkshop() {
            document.getElementById('machineListPage').classList.add('hidden');
            document.getElementById('workshopTracker').classList.remove('hidden');
        }

        function renderMachineList() {
            const machines = getWorkshopMachines();
            const content = document.getElementById('machineListContent');
            
            if (machines.length === 0) {
                content.innerHTML = '<div class="text-center py-12"><p class="text-gray-600 text-xl">No machines added to this workshop yet.</p><p class="text-gray-500 mt-2">Go to home page and click "Add Machine" to get started.</p></div>';
                return;
            }

            const totalMachines = machines.length;
            const workingMachines = machines.filter(m => (machineStatuses[m.id] || 'Working') === 'Working').length;
            const underMaintenance = machines.filter(m => (machineStatuses[m.id] || 'Working') === 'Under Maintenance').length;
            const brokenDown = machines.filter(m => (machineStatuses[m.id] || 'Working') === 'Broken Down').length;

            content.innerHTML = `
                <!-- Statistics Cards -->
                <div class="grid grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-2xl border-2 border-gray-300 shadow-lg">
                        <div class="text-5xl font-bold text-gray-800">${totalMachines}</div>
                        <div class="text-sm text-gray-600 font-medium mt-2">Total Machines</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-2xl border-2 border-green-300 shadow-lg">
                        <div class="text-5xl font-bold text-green-800">${workingMachines}</div>
                        <div class="text-sm text-green-600 font-medium mt-2">Working</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-2xl border-2 border-yellow-300 shadow-lg">
                        <div class="text-5xl font-bold text-yellow-800">${underMaintenance}</div>
                        <div class="text-sm text-yellow-600 font-medium mt-2">Under Repair</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-2xl border-2 border-red-300 shadow-lg">
                        <div class="text-5xl font-bold text-red-800">${brokenDown}</div>
                        <div class="text-sm text-red-600 font-medium mt-2">Out of Order</div>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-xl border-2 border-cyan-200">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-cyan-700 to-cyan-800 text-white">
                            <tr>
                                <th class="text-left p-4 font-bold">Machine Name</th>
                                <th class="text-left p-4 font-bold">Category</th>
                                <th class="text-left p-4 font-bold">ID Number</th>
                                <th class="text-left p-4 font-bold">Year</th>
                                <th class="text-left p-4 font-bold">Country</th>
                                <th class="text-left p-4 font-bold">Status</th>
                                <th class="text-left p-4 font-bold">Change Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${machines.map(machine => {
                                const status = machineStatuses[machine.id] || 'Working';
                                const statusColor = status === 'Working' ? 'bg-green-100 text-green-800 border-green-400' : 
                                                   status === 'Under Maintenance' ? 'bg-yellow-100 text-yellow-800 border-yellow-400' : 
                                                   'bg-red-100 text-red-800 border-red-400';
                                
                                return `
                                    <tr class="border-b-2 hover:bg-cyan-50 transition">
                                        <td class="p-4">
                                            <div class="font-bold text-gray-800">${machine.name}</div>
                                            ${machine.description ? `<div class="text-xs text-gray-500 mt-1">${machine.description}</div>` : ''}
                                        </td>
                                        <td class="p-4">${machine.category || '-'}</td>
                                        <td class="p-4 text-sm">${machine.identification || '-'}</td>
                                        <td class="p-4 text-sm">${machine.year || '-'}</td>
                                        <td class="p-4 text-sm">${machine.country || '-'}</td>
                                        <td class="p-4">
                                            <span class="px-4 py-2 rounded-xl text-sm border-2 font-bold ${statusColor}">
                                                ${status}
                                            </span>
                                        </td>
                                        <td class="p-4">
                                            <select onchange="updateMachineStatus(${machine.id}, this.value)" class="p-2 border-2 rounded-lg text-sm font-medium w-full">
                                                <option value="Working" ${status === 'Working' ? 'selected' : ''}>Working</option>
                                                <option value="Under Maintenance" ${status === 'Under Maintenance' ? 'selected' : ''}>Under Maintenance</option>
                                                <option value="Broken Down" ${status === 'Broken Down' ? 'selected' : ''}>Broken Down</option>
                                            </select>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function updateMachineStatus(machineId, newStatus) {
            machineStatuses[machineId] = newStatus;
            renderMachineList();
            alert('Machine status updated successfully!');
        }

        function updateCategoriesByWorkshop() {
            const workshop = document.getElementById('machineWorkshop').value;
            const categorySelect = document.getElementById('machineCategory');
            const nameSelect = document.getElementById('machineName');
            
            if (!workshop) {
                categorySelect.innerHTML = '<option value="">Select workshop first</option>';
                nameSelect.innerHTML = '<option value="">Select category first</option>';
                return;
            }
            
            const categories = categoriesByWorkshop[workshop] || [];
            if (categories.length === 0) {
                categorySelect.innerHTML = '<option value="">No categories available for this workshop</option>';
                nameSelect.innerHTML = '<option value="">Select category first</option>';
                return;
            }
            
            categorySelect.innerHTML = '<option value="">Select Category</option>' + 
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            nameSelect.innerHTML = '<option value="">Select category first</option>';
        }

        function updateMachineNames() {
            const category = document.getElementById('machineCategory').value;
            const nameSelect = document.getElementById('machineName');
            
            if (!category) {
                nameSelect.innerHTML = '<option value="">Select category first</option>';
                return;
            }
            
            const names = machineNamesByCategory[category] || [];
            nameSelect.innerHTML = '<option value="">Select Machine Name</option>' + 
                names.map(name => `<option value="${name}">${name}</option>`).join('');
        }

        function attemptLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('landingPage').classList.remove('hidden');
                document.getElementById('loginError').classList.add('hidden');
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            isAuthenticated = false;
            document.getElementById('workshopTracker').classList.add('hidden');
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('machineManagementPage').classList.add('hidden');
            document.getElementById('engineerManagementPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showMachineManagement() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('machineManagementPage').classList.remove('hidden');
            renderMachinesList();
        }

        function showEngineerManagement() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('engineerManagementPage').classList.remove('hidden');
            renderEngineersList();
        }

        function backToHome() {
            document.getElementById('machineManagementPage').classList.add('hidden');
            document.getElementById('engineerManagementPage').classList.add('hidden');
            document.getElementById('landingPage').classList.remove('hidden');
        }

        function openWorkshop(workshop, description) {
            if (!isAuthenticated) {
                alert('Please login first!');
                return;
            }
            currentWorkshop = workshop;
            currentWorkshopDescription = description;
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('workshopTracker').classList.remove('hidden');
            document.getElementById('workshopTitle').textContent = workshop;
            document.getElementById('workshopDescription').textContent = description;
            renderAll();
        }

        function goHome() {
            document.getElementById('workshopTracker').classList.add('hidden');
            document.getElementById('landingPage').classList.remove('hidden');
            currentWorkshop = '';
            currentWorkshopDescription = '';
        }

        function getWorkshopMachines() {
            return machinesByWorkshop[currentWorkshop] || [];
        }

        function getWorkshopTasks() {
            return allTasks.filter(t => t.workshop === currentWorkshop);
        }

        function renderAll() {
            checkAndUpdateTaskStatuses();
            renderTasks();
            updateStats();
            updateDropdowns();
            updateNotifications();
        }

        function checkAndUpdateTaskStatuses() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            allTasks.forEach(task => {
                if (task.status === 'completed') {
                    const nextDue = new Date(task.nextDueDate);
                    nextDue.setHours(0, 0, 0, 0);
                    
                    if (today.getTime() >= nextDue.getTime()) {
                        task.status = 'pending';
                        task.notificationSent = false;
                    }
                }
            });
        }

        function toggleImport() {
            const panel = document.getElementById('importPanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) updateDropdowns();
        }

        function toggleNotifications() {
            document.getElementById('notifPanel').classList.toggle('hidden');
        }

        function toggleAddTask() {
            const panel = document.getElementById('addTaskPanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                const machineSelect = document.getElementById('taskMachine');
                machineSelect.value = '';
                machineSelect.style.color = '#9CA3AF';
                const prioritySelect = document.getElementById('taskPriority');
                prioritySelect.value = '';
                prioritySelect.style.color = '#9CA3AF';
                document.getElementById('taskName').value = '';
                document.getElementById('taskLastDone').value = '';
                document.getElementById('taskNextDue').value = '';
                const freqSelect = document.getElementById('taskFreq');
                freqSelect.value = '';
                freqSelect.style.color = '#9CA3AF';
                updateDropdowns();
            }
        }

        function saveMachine() {
            const workshop = document.getElementById('machineWorkshop').value;
            const category = document.getElementById('machineCategory').value;
            const name = document.getElementById('machineName').value;
            const identification = document.getElementById('machineIdentification').value.trim();
            const year = document.getElementById('machineYear').value.trim();
            const country = document.getElementById('machineCountry').value.trim();
            const description = document.getElementById('machineDescription').value.trim();

            if (!workshop) {
                alert('Please select workshop');
                return;
            }

            if (!category) {
                alert('Please select machine category');
                return;
            }

            if (!name) {
                alert('Please select machine name');
                return;
            }

            machinesByWorkshop[workshop].push({
                id: machineIdCounter++,
                category: category,
                name: name,
                workshop: workshop,
                identification: identification,
                year: year,
                country: country,
                description: description
            });

            // Initialize machine status as "Working"
            machineStatuses[machineIdCounter - 1] = 'Working';

            alert('Machine added successfully to ' + workshop + '!');
            renderMachinesList();
            if (currentWorkshop) {
                updateDropdowns();
            }
            
            document.getElementById('machineWorkshop').value = '';
            document.getElementById('machineCategory').innerHTML = '<option value="">Select workshop first</option>';
            document.getElementById('machineName').innerHTML = '<option value="">Select category first</option>';
            document.getElementById('machineIdentification').value = '';
            document.getElementById('machineYear').value = '';
            document.getElementById('machineCountry').value = '';
            document.getElementById('machineDescription').value = '';
        }

        function saveEngineer() {
            const name = document.getElementById('engineerName').value.trim();
            const email = document.getElementById('engineerEmail').value.trim();
            const department = document.getElementById('engineerDept').value.trim();

            if (!name || !email) {
                alert('Please enter engineer name and email');
                return;
            }

            const maxId = engineers.length > 0 ? Math.max(...engineers.map(e => e.id)) : 0;
            engineers.push({
                id: maxId + 1,
                name: name,
                email: email,
                department: department
            });

            alert('Engineer added successfully!');
            renderEngineersList();
            if (currentWorkshop) {
                updateDropdowns();
            }
            
            document.getElementById('engineerName').value = '';
            document.getElementById('engineerEmail').value = '';
            document.getElementById('engineerDept').value = '';
        }

        function saveTask() {
            const machineId = document.getElementById('taskMachine').value;
            const priority = document.getElementById('taskPriority').value;
            const taskName = document.getElementById('taskName').value.trim();
            const lastDone = document.getElementById('taskLastDone').value;
            const nextDue = document.getElementById('taskNextDue').value;
            const engineerId = parseInt(document.getElementById('taskEngineer').value);
            const frequency = document.getElementById('taskFreq').value;

            if (!machineId || !priority || !taskName || !nextDue || !frequency) {
                alert('Please fill in all required fields');
                return;
            }

            const maxId = allTasks.length > 0 ? Math.max(...allTasks.map(t => t.id)) : 0;
            allTasks.push({
                id: maxId + 1,
                machineId: parseInt(machineId),
                priority: priority,
                workshop: currentWorkshop,
                task: taskName,
                lastDoneDate: lastDone,
                nextDueDate: nextDue,
                status: 'pending',
                engineerId: engineerId,
                notificationSent: false,
                frequency: frequency
            });

            alert('Task added successfully!');
            renderAll();
            toggleAddTask();
        }

        function renderMachinesList() {
            const list = document.getElementById('machinesList');
            if (!list) return;
            
            let html = '';
            Object.keys(machinesByWorkshop).forEach(workshop => {
                const machines = machinesByWorkshop[workshop];
                if (machines.length > 0) {
                    html += `<div class="mb-4">
                        <h5 class="font-bold text-md mb-2 text-gray-700">${workshop}:</h5>
                        ${machines.map(m => `
                            <div class="bg-white p-4 rounded-xl border-2 mb-2 shadow-sm ml-4">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-bold text-lg mb-1">${m.category ? m.category + ' - ' : ''}${m.name}</div>
                                        ${m.identification ? `<div class="text-sm text-gray-600"><strong>ID:</strong> ${m.identification}</div>` : ''}
                                        ${m.year || m.country ? `<div class="text-sm text-gray-600">
                                            ${m.year ? `<strong>Year:</strong> ${m.year}` : ''}
                                            ${m.year && m.country ? ' | ' : ''}
                                            ${m.country ? `<strong>Country:</strong> ${m.country}` : ''}
                                        </div>` : ''}
                                        ${m.description ? `<div class="text-sm text-gray-500 mt-1"><strong>Description:</strong> ${m.description}</div>` : ''}
                                    </div>
                                    <button onclick="deleteMachine(${m.id}, '${workshop}')" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 font-medium ml-4">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }
            });
            
            if (html === '') {
                list.innerHTML = '<p class="text-gray-500 text-sm">No machines added yet.</p>';
            } else {
                list.innerHTML = html;
            }
        }

        function renderEngineersList() {
            const list = document.getElementById('engineersList');
            if (!list) return;
            
            if (engineers.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm">No engineers added yet.</p>';
                return;
            }
            
            list.innerHTML = engineers.map(e => `
                <div class="bg-white p-3 rounded-xl border-2 mb-3 flex justify-between items-center shadow-sm">
                    <div>
                        <span class="font-bold">${e.name}</span>
                        <span class="text-sm text-gray-600 ml-2">(${e.email})</span>
                        ${e.department ? `<span class="text-sm text-gray-500 ml-2">- ${e.department}</span>` : ''}
                    </div>
                    <button onclick="deleteEngineer(${e.id})" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 font-medium">Delete</button>
                </div>
            `).join('');
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 'High': return 'text-red-600 font-bold';
                case 'Medium': return 'text-orange-600 font-bold';
                case 'Low': return 'text-green-600 font-semibold';
                default: return 'text-gray-600';
            }
        }

        function renderTasks() {
            const tbody = document.getElementById('tasksTable');
            const workshopTasks = getWorkshopTasks();
            const machines = getWorkshopMachines();
            
            let filtered = workshopTasks.filter(t => currentFilter === 'all' || t.status === currentFilter);
            
            if (machineSearchQuery) {
                filtered = filtered.filter(t => {
                    const machine = machines.find(m => m.id === t.machineId);
                    return machine && machine.name.toLowerCase().includes(machineSearchQuery.toLowerCase());
                });
            }
            
            tbody.innerHTML = filtered.map(task => {
                const machine = machines.find(m => m.id === task.machineId);
                const engineer = engineers.find(e => e.id === task.engineerId);
                const statusColor = getStatusColor(task.status);
                const priorityColor = getPriorityColor(task.priority);
                
                return `
                    <tr class="border-b-2 hover:bg-blue-50 transition">
                        <td class="p-4">
                            <div class="font-bold text-gray-800">${machine ? machine.name : 'Unknown'}</div>
                        </td>
                        <td class="p-4 ${priorityColor}">${task.priority}</td>
                        <td class="p-4 font-medium">${task.task}</td>
                        <td class="p-4">${task.lastDoneDate || '-'}</td>
                        <td class="p-4 font-medium">${task.nextDueDate}</td>
                        <td class="p-4 text-sm">${task.frequency}</td>
                        <td class="p-4">
                            <span class="px-4 py-2 rounded-xl text-sm border-2 font-bold ${statusColor}">
                                ${task.status}
                            </span>
                        </td>
                        <td class="p-4">
                            <div class="text-sm">
                                <div class="font-bold">${engineer ? engineer.name : 'Unassigned'}</div>
                                <div class="text-gray-500 text-xs">${engineer ? engineer.email : ''}</div>
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="flex gap-2">
                                <select onchange="updateTaskStatus(${task.id}, this.value)" class="p-2 border-2 rounded-lg text-sm font-medium">
                                    <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="overdue" ${task.status === 'overdue' ? 'selected' : ''}>Overdue</option>
                                </select>
                                <button onclick="deleteTask(${task.id})" class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-red-600 font-medium">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-6 text-center text-gray-500 text-lg">No tasks found matching your filters.</td></tr>';
            }
        }

        function updateStats() {
            const workshopTasks = getWorkshopTasks();
            document.getElementById('statTotal').textContent = workshopTasks.length;
            document.getElementById('statCompleted').textContent = workshopTasks.filter(t => t.status === 'completed').length;
            document.getElementById('statInProgress').textContent = workshopTasks.filter(t => t.status === 'in-progress').length;
            document.getElementById('statPending').textContent = workshopTasks.filter(t => t.status === 'pending').length;
            document.getElementById('statOverdue').textContent = workshopTasks.filter(t => t.status === 'overdue').length;
        }

        function updateDropdowns() {
            const machines = getWorkshopMachines();
            const machineSelect = document.getElementById('taskMachine');
            const importMachine = document.getElementById('importMachine');
            const importEngineer = document.getElementById('importEngineer');
            const engineerSelect = document.getElementById('taskEngineer');

            if (machineSelect) {
                if (machines.length === 0) {
                    machineSelect.innerHTML = '<option value="" disabled selected>No machines available - Add machines from home page</option>';
                } else {
                    machineSelect.innerHTML = '<option value="" disabled selected style="color: #9CA3AF;">Machine</option>' + 
                        machines.map(m => `<option value="${m.id}" style="color: black;">${m.name}</option>`).join('');
                }
            }

            if (importMachine) {
                if (machines.length === 0) {
                    importMachine.innerHTML = '<option value="" disabled selected>No machines available</option>';
                } else {
                    importMachine.innerHTML = machines.map(m => 
                        `<option value="${m.id}">${m.name}</option>`
                    ).join('');
                }
            }

            if (importEngineer) {
                importEngineer.innerHTML = engineers.map(e => 
                    `<option value="${e.id}">${e.name}</option>`
                ).join('');
            }

            if (engineerSelect) {
                engineerSelect.innerHTML = engineers.map(e => 
                    `<option value="${e.id}">${e.name}</option>`
                ).join('');
            }
        }

        function updateNotifications() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const workshopTasks = getWorkshopTasks();
            const notifNeeded = workshopTasks.filter(task => {
                const dueDate = new Date(task.nextDueDate);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate.getTime() === tomorrow.getTime() && 
                       task.status !== 'completed' && 
                       !task.notificationSent;
            });

            const tasksByEngineer = {};
            notifNeeded.forEach(task => {
                if (!tasksByEngineer[task.engineerId]) {
                    tasksByEngineer[task.engineerId] = [];
                }
                tasksByEngineer[task.engineerId].push(task);
            });

            const badge = document.getElementById('notifBadge');
            const engineerCount = Object.keys(tasksByEngineer).length;
            if (engineerCount > 0) {
                badge.innerHTML = `<span class="ml-2 bg-red-500 text-white text-xs rounded-full px-2 py-1 font-bold">${engineerCount}</span>`;
            } else {
                badge.innerHTML = '';
            }

            const content = document.getElementById('notifContent');
            if (engineerCount === 0) {
                content.innerHTML = '<p class="text-gray-600 text-lg">No notifications need to be sent today.</p>';
            } else {
                const machines = getWorkshopMachines();
                content.innerHTML = Object.keys(tasksByEngineer).map(engineerId => {
                    const engineer = engineers.find(e => e.id === parseInt(engineerId));
                    const engineerTasks = tasksByEngineer[engineerId];
                    
                    const tasksByMachine = {};
                    engineerTasks.forEach(task => {
                        if (!tasksByMachine[task.machineId]) {
                            tasksByMachine[task.machineId] = [];
                        }
                        tasksByMachine[task.machineId].push(task);
                    });
                    
                    return `
                        <div class="bg-white p-6 rounded-xl border-2 border-orange-300 mb-4 shadow-lg">
                            <div class="font-bold text-xl text-gray-800 mb-3">
                                üîß Email to: ${engineer ? engineer.name : 'Unknown'} (${engineer ? engineer.email : ''})
                            </div>
                            <div class="text-sm text-gray-600 mb-4">
                                ${engineerTasks.length} task${engineerTasks.length > 1 ? 's' : ''} due tomorrow
                            </div>
                            
                            <div class="mt-3 p-5 bg-blue-50 rounded-xl border-2 border-blue-200">
                                <div class="font-bold mb-3 text-lg">Email Content:</div>
                                <div class="text-gray-700 text-sm whitespace-pre-line font-mono">
<strong>Subject:</strong> Maintenance Reminder - ${engineerTasks.length} Task${engineerTasks.length > 1 ? 's' : ''} Due Tomorrow

Dear ${engineer ? engineer.name : 'Engineer'},

This is a reminder that you have ${engineerTasks.length} maintenance task${engineerTasks.length > 1 ? 's' : ''} scheduled for tomorrow (${engineerTasks[0].nextDueDate}):

${Object.keys(tasksByMachine).map(machineId => {
    const machine = machines.find(m => m.id === parseInt(machineId));
    const machineTasks = tasksByMachine[machineId];
    return `<strong>Machine: ${machine ? machine.name : 'Unknown'}</strong>
${machineTasks.map((task, idx) => `  ${idx + 1}. ${task.task} (${task.frequency})`).join('\n')}`;
}).join('\n\n')}

Please ensure all maintenance tasks are completed as scheduled.

Best regards,
Maintenance Management System
                                </div>
                            </div>
                            
                            <button onclick="markEngineerNotificationsSent(${engineerId})" class="mt-4 bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 font-bold shadow-lg">
                                Mark All as Sent
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }

        function markEngineerNotificationsSent(engineerId) {
            allTasks.forEach(task => {
                if (task.engineerId === parseInt(engineerId) && !task.notificationSent && task.workshop === currentWorkshop) {
                    const dueDate = new Date(task.nextDueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    if (dueDate.getTime() === tomorrow.getTime() && task.status !== 'completed') {
                        task.notificationSent = true;
                    }
                }
            });
            updateNotifications();
            renderTasks();
            alert('Notifications marked as sent!');
        }

        function getStatusColor(status) {
            switch(status) {
                case 'completed': return 'bg-green-100 text-green-800 border-green-400';
                case 'in-progress': return 'bg-blue-100 text-blue-800 border-blue-400';
                case 'overdue': return 'bg-red-100 text-red-800 border-red-400';
                default: return 'bg-yellow-100 text-yellow-800 border-yellow-400';
            }
        }

        function updateTaskStatus(taskId, newStatus) {
            const task = allTasks.find(t => t.id === taskId);
            if (task) {
                if (newStatus === 'completed') {
                    const today = new Date();
                    task.lastDoneDate = today.toISOString().split('T')[0];
                    
                    let nextDate;
                    const freq = task.frequency.toLowerCase().replace(/[\s-]/g, '');
                    
                    if (freq === 'daily') {
                        nextDate = new Date(today);
                        nextDate.setDate(nextDate.getDate() + 1);
                    } else if (freq === 'weekly') {
                        nextDate = new Date(today);
                        nextDate.setDate(nextDate.getDate() + 7);
                    } else if (freq === 'monthly' || freq === '1monthly') {
                        nextDate = new Date(today);
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    } else if (freq === 'quarterly' || freq === '3monthly') {
                        nextDate = new Date(today);
                        nextDate.setMonth(nextDate.getMonth() + 3);
                    } else if (freq === 'semiannually' || freq === '6monthly') {
                        nextDate = new Date(today);
                        nextDate.setMonth(nextDate.getMonth() + 6);
                    } else if (freq === 'annually') {
                        nextDate = new Date(today);
                        nextDate.setFullYear(nextDate.getFullYear() + 1);
                    } else {
                        nextDate = new Date(today);
                        nextDate.setDate(nextDate.getDate() + 1);
                    }
                    
                    task.nextDueDate = nextDate.toISOString().split('T')[0];
                    task.status = 'completed';
                    task.notificationSent = false;
                    
                    alert(`Task completed!\nLast Done: ${task.lastDoneDate}\nNext Due: ${task.nextDueDate}\nStatus will change to 'Pending' on ${task.nextDueDate}`);
                } else {
                    task.status = newStatus;
                }
                
                renderAll();
            }
        }

        function filterTasks(filter) {
            currentFilter = filter;
            
            ['All', 'Pending', 'InProgress', 'Overdue', 'Completed'].forEach(f => {
                const btn = document.getElementById('filter' + f);
                if (btn) {
                    btn.className = 'px-5 py-2 rounded-xl font-medium shadow-md ' + (filter === f.toLowerCase().replace('inprogress', 'in-progress') ? 'bg-blue-600 text-white' : 'bg-gray-200');
                }
            });
            
            renderTasks();
        }

        function searchMachines() {
            machineSearchQuery = document.getElementById('machineSearch').value;
            renderTasks();
        }

        function clearSearch() {
            document.getElementById('machineSearch').value = '';
            machineSearchQuery = '';
            renderTasks();
        }

        function deleteMachine(machineId, workshop) {
            if (confirm('Are you sure you want to delete this machine?')) {
                machinesByWorkshop[workshop] = machinesByWorkshop[workshop].filter(m => m.id !== machineId);
                renderMachinesList();
                if (currentWorkshop) {
                    updateDropdowns();
                    renderTasks();
                }
                alert('Machine deleted successfully!');
            }
        }

        function deleteEngineer(engineerId) {
            if (confirm('Are you sure you want to delete this engineer?')) {
                engineers = engineers.filter(e => e.id !== engineerId);
                renderEngineersList();
                if (currentWorkshop) {
                    updateDropdowns();
                    renderTasks();
                }
                alert('Engineer deleted successfully!');
            }
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                allTasks = allTasks.filter(t => t.id !== taskId);
                renderAll();
                alert('Task deleted successfully!');
            }
        }

        function calculateNextDueDate() {
            const lastDone = document.getElementById('taskLastDone').value;
            const frequency = document.getElementById('taskFreq').value;
            
            if (!lastDone || !frequency) return;
            
            const lastDate = new Date(lastDone);
            let nextDate = new Date(lastDate);
            
            const freq = frequency.toLowerCase().replace(/[\s-]/g, '');
            
            if (freq === 'daily') {
                nextDate.setDate(nextDate.getDate() + 1);
            } else if (freq === 'weekly') {
                nextDate.setDate(nextDate.getDate() + 7);
            } else if (freq === 'monthly') {
                nextDate.setMonth(nextDate.getMonth() + 1);
            } else if (freq === 'quarterly') {
                nextDate.setMonth(nextDate.getMonth() + 3);
            } else if (freq === 'semiannually') {
                nextDate.setMonth(nextDate.getMonth() + 6);
            } else if (freq === 'annually') {
                nextDate.setFullYear(nextDate.getFullYear() + 1);
            }
            
            document.getElementById('taskNextDue').value = nextDate.toISOString().split('T')[0];
        }

        function exportData() {
            const data = { machinesByWorkshop, engineers, allTasks, allBreakdowns, machineStatuses };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `maintenance-data-${currentWorkshop}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function loadData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.machinesByWorkshop) machinesByWorkshop = data.machinesByWorkshop;
                    if (data.engineers) engineers = data.engineers;
                    if (data.allTasks) allTasks = data.allTasks;
                    if (data.allBreakdowns) allBreakdowns = data.allBreakdowns;
                    if (data.machineStatuses) machineStatuses = data.machineStatuses;
                    
                    let maxId = 0;
                    Object.values(machinesByWorkshop).forEach(machines => {
                        machines.forEach(m => {
                            if (m.id > maxId) maxId = m.id;
                        });
                    });
                    machineIdCounter = maxId + 1;
                    
                    if (allBreakdowns && allBreakdowns.length > 0) {
                        const maxBreakdownId = Math.max(...allBreakdowns.map(b => b.id));
                        breakdownIdCounter = maxBreakdownId + 1;
                    }
                    
                    if (currentWorkshop) {
                        renderAll();
                        if (currentTab === 'breakdown') {
                            renderBreakdowns();
                        }
                    }
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function importExcelData() {
            const machineId = document.getElementById('importMachine').value;
            const engineerId = parseInt(document.getElementById('importEngineer').value);
            const startDate = document.getElementById('importDate').value;
            const pasteData = document.getElementById('importData').value.trim();

            if (!machineId || !startDate || !pasteData) {
                alert('Please select machine, provide start date and paste your Excel data');
                return;
            }

            const lines = pasteData.split('\n');
            let imported = 0;
            const maxId = allTasks.length > 0 ? Math.max(...allTasks.map(t => t.id)) : 0;
            let newId = maxId + 1;

            lines.forEach(line => {
                const cells = line.split('\t');
                if (cells.length >= 2) {
                    const taskName = cells[0]?.trim();
                    const frequency = cells[1]?.trim();
                    
                    if (taskName && frequency) {
                        allTasks.push({
                            id: newId++,
                            machineId: parseInt(machineId),
                            priority: 'Medium',
                            workshop: currentWorkshop,
                            task: taskName,
                            lastDoneDate: '',
                            nextDueDate: startDate,
                            status: 'pending',
                            engineerId: engineerId,
                            notificationSent: false,
                            frequency: frequency
                        });
                        imported++;
                    }
                }
            });

            if (imported > 0) {
                alert(`Successfully imported ${imported} maintenance tasks!`);
                document.getElementById('importData').value = '';
                renderAll();
                toggleImport();
            } else {
                alert('No valid data found. Please check your paste format.');
            }
        }
    </script>
</body>
</html>